@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer localizer
@model WordVision.ec.Web.Areas.Maestro.Models.ModeloProyectoViewModel

<div class="row">
    <div class="col-md-12">
        <form id="create-form" method="post" asp-controller="ModeloProyecto" asp-action="OnPostCreateOrEdit" asp-route-id="@Model.Id" onsubmit="return jQueryModalPost(this);" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input hidden="hidden" asp-for="Id" />
            <div class="form-group">
                <label asp-for="Codigo" class="control-label">Código</label>
                <input asp-for="Codigo" class="form-control" id="codigo_mp" />
                <span asp-validation-for="Codigo" class="text-danger" id="codigo_mp_error"></span>
            </div>
            <div class="form-group">
                <label asp-for="Descripcion" class="control-label">Descripción</label>
                <input asp-for="Descripcion" class="form-control" id="descripcion_mp" />
                <span asp-validation-for="Descripcion" class="text-danger" id="descripcion_mp_error"></span>
            </div>
            <div class="form-group grupoSeleccion">
                <label asp-for="IdEtapaModeloProyecto" class="control-label">Etapa Modelo Proyecto</label>
                @if (Model.Id == 0)
                {
                    @Html.DropDownList("IdEtapaModeloProyecto", (IEnumerable<SelectListItem>)Model.EtapaModeloProyectoList, htmlAttributes: new { @class = "form-control seleccionBusqueda", @style = "width:100%;", @id = "etapa_mp_seleccion", @multiple = "true" })
                }
                else
                {
                    @Html.DropDownList("IdEtapaModeloProyecto", (IEnumerable<SelectListItem>)Model.EtapaModeloProyectoList, htmlAttributes: new { @class = "form-control seleccionBusqueda", @style = "width:100%;" })
                }
                <span asp-validation-for="IdEtapaModeloProyecto" class="text-danger" id="etapa_mp_seleccion_error"></span>
            </div>
            @if (Model.Id != 0)
            {
                <div class="form-group">
                    <label asp-for="IdEstado" class="control-label">Estado</label>
                    @Html.DropDownList("IdEstado", (IEnumerable<SelectListItem>)Model.EstadoList, htmlAttributes: new { @class = "form-control", @style = "width:100%;" })
                    <span asp-validation-for="IdEstado" class="text-danger"></span>
                </div>
            }
            <br />
            <div class="form-group justify-content-between group-button-modal">
                @if (Model.Id == 0)
                {
                    <button type="button" class="btn btn-success" id="btn_guardar_mp">Guardar</button>
                }
                else
                {
                    <button type="submit" class="btn btn-success">Guardar</button>

                }
                <button type="button" class="btn btn-default close-button" data-dismiss="modal" id="btn_cancelar_mp">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript" language=javascript>
    $.validator.unobtrusive.parse(document);
    $('#create-form').disableAutoFill();

    $('.seleccionBusqueda').select2();

    $('#etapa_mp_seleccion').on('select2:opening select2:closing', function (event) {
        var $searchfield = $(this).parent().find('.select2-search__field');
        $searchfield.prop('disabled', true);
    });

    $("#codigo_mp").on('change keyup paste', function (event) {
        $("#codigo_mp_error").text('')
    })

    $("#descripcion_mp").on('change keyup paste', function (event) {
        $("#descripcion_mp_error").text('')
    })

    $("#etapa_mp_seleccion").on('change', function (event) {
        $("#etapa_mp_seleccion_error").text('')
    })

    $('#btn_guardar_mp').on('click', function (event) {
        var listaEtapasMult = $(".select2-selection__choice");
        var etapasList = $("#etapa_mp_seleccion option");
        var codigo = $("#codigo_mp").val()
        var descripcion = $("#descripcion_mp").val()

        var listaEtapasModel = etapasList.map((ind, al) => {

            var id = parseInt(al.value);
            var text = al.text;

            if (listaEtapasMult.map((ind, la) => la.title).toArray().find(x => x.toUpperCase() === text.toUpperCase()))
                return {
                    Id: id,
                    Etapa: text
                }
            else
                return {
                    Id: 0,
                }
        }).toArray().filter(x => x.Id !== 0)

        var EtapaModeloProyectoMultipleViewModel = {
            Codigo: codigo,
            Descripcion: descripcion,
            EtapaModeloProyectos: listaEtapasModel
        }

        var valido = true;

        if (!codigo) {
            $("#codigo_mp_error").text('Código es obligatorio.')
            valido = false
        }

        if (!descripcion) {
            $("#descripcion_mp_error").text('Descripción es obligatorio.')
            valido = false
        }

        if (listaEtapasModel.length === 0) {
            $("#etapa_mp_seleccion_error").text('Estapa es obligatorio.')
            valido = false
        }

        if (valido)
            $.ajax({
                type: "post",
                url:'@Url.Action("OnPostCreateMultiple", "ModeloProyecto", new { area = "maestro" })',
                data: EtapaModeloProyectoMultipleViewModel,
                datatype: "json",
                cache: false,
                success: function (data) {
                    if (data.isValid) {
                        $("#reloadMP").trigger('click');
                        $("#btn_cancelar_mp").trigger('click');
                    }
                },
                error: function(xhr) {

                }
            });


    })
</script>

